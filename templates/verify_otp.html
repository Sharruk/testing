{% extends "base.html" %}

{% block title %}Verify OTP - College Materials & PYQs Portal{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{{ url_for('index') }}"><i class="fas fa-home me-1"></i>Home</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('verify_ssn_email') }}">Verify SSN Email</a>
            </li>
            <li class="breadcrumb-item active">Enter OTP</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-key me-2"></i>Enter Verification Code
                </h4>
            </div>
            <div class="card-body text-center">
                <div class="alert alert-info">
                    <i class="fas fa-envelope me-2"></i>
                    We've sent a 6-digit verification code to your SSN email address. 
                    Please check your inbox and enter the code below.
                </div>

                <form method="POST" id="otpForm">
                    {{ csrf_token() }}
                    
                    <div class="mb-4">
                        <label for="otp" class="form-label">
                            <i class="fas fa-shield-alt me-1"></i>Verification Code
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg text-center" 
                               id="otp" 
                               name="otp" 
                               placeholder="000000"
                               maxlength="6"
                               pattern="[0-9]{6}"
                               style="font-size: 24px; letter-spacing: 8px; font-weight: bold;"
                               required>
                        <div class="form-text">
                            <i class="fas fa-clock me-1"></i>
                            Code expires in <span id="timer" class="fw-bold text-danger">10:00</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mb-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check-circle me-2"></i>Verify & Activate
                        </button>
                    </div>
                </form>

                <div class="text-center">
                    <p class="text-muted">Didn't receive the code?</p>
                    <button id="resendBtn" class="btn btn-outline-primary" onclick="resendOTP()">
                        <i class="fas fa-redo me-2"></i>Resend Code
                    </button>
                    <div id="resendStatus" class="mt-2"></div>
                </div>

                <hr class="my-4">
                
                <div class="row text-start">
                    <div class="col-12">
                        <h6 class="text-success">
                            <i class="fas fa-trophy me-1"></i>After Verification:
                        </h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-2"></i>Contributor badge in navigation</li>
                            <li><i class="fas fa-check text-success me-2"></i>Access to upload functionality</li>
                            <li><i class="fas fa-check text-success me-2"></i>Content management permissions</li>
                            <li><i class="fas fa-check text-success me-2"></i>Welcome email confirmation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="alert alert-warning mt-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Security Tips:</strong>
            <ul class="mb-0 mt-2 small">
                <li>Don't share this code with anyone</li>
                <li>The code expires in 10 minutes</li>
                <li>Close this tab after verification</li>
            </ul>
        </div>
    </div>
</div>

<script>
// OTP input formatting
document.getElementById('otp').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
});

// Countdown timer
let timeLeft = 600; // 10 minutes in seconds
const timer = document.getElementById('timer');

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
        timer.textContent = "EXPIRED";
        timer.className = "fw-bold text-danger";
        document.getElementById('otp').disabled = true;
        document.querySelector('button[type="submit"]').disabled = true;
        alert('Verification code has expired. Please request a new one.');
    }
    
    if (timeLeft <= 60) {
        timer.className = "fw-bold text-danger";
    }
    
    timeLeft--;
}

// Start timer
updateTimer();
const timerInterval = setInterval(updateTimer, 1000);

// Resend OTP function
function resendOTP() {
    const resendBtn = document.getElementById('resendBtn');
    const resendStatus = document.getElementById('resendStatus');
    
    resendBtn.disabled = true;
    resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    
    fetch('/resend-otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resendStatus.innerHTML = '<div class="alert alert-success py-2">Code sent successfully!</div>';
            // Reset timer
            timeLeft = 600;
            document.getElementById('otp').disabled = false;
            document.querySelector('button[type="submit"]').disabled = false;
            timer.className = "fw-bold text-danger";
        } else {
            resendStatus.innerHTML = '<div class="alert alert-danger py-2">' + data.message + '</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resendStatus.innerHTML = '<div class="alert alert-danger py-2">Failed to resend code.</div>';
    })
    .finally(() => {
        resendBtn.disabled = false;
        resendBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Resend Code';
    });
}

// Auto-submit when 6 digits are entered
document.getElementById('otp').addEventListener('input', function() {
    if (this.value.length === 6) {
        // Small delay to allow user to see the complete code
        setTimeout(() => {
            document.getElementById('otpForm').submit();
        }, 500);
    }
});
</script>
{% endblock %}